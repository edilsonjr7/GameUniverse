<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>GameStreamUniverse</title>

    <link rel="stylesheet" href="estilo.css">
    <link rel="shortcut icon" href="imagem/logoApp.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

    <header class="main-header">
        <div class="logo">
            <a href="index.html">
                <img src="imagem/logoApp.png" alt="GameUniverse Logo">
            </a>
        </div>

        <nav class="main-nav">
            <ul class="nav-links">
                <li><a href="categorias.html">Categorias</a></li>
                <li><a href="#">Jogos Mais Acessados</a></li>
                <li><a href="#">Novidades</a></li>
            </ul>
        </nav>

        <div class="header-actions">
            <div class="search-bar">
                <input type="text" placeholder="Pesquisar jogos...">
                <i class="fas fa-search"></i>
            </div>

            <div class="shopping-cart" title="Carrinho">
                <i class="fas fa-shopping-cart"></i>
                <div class="cart-count">0</div> </div>

           <button id="authButton" class="login-btn">Entrar</button>
        </div>
    </header>

    <main>
        <h1>Paraíso dos Jogos: Diversão para Todos os Estilos.</h1>
        <strong>Sua loja de jogos preferida é aqui</strong>

        <div class="carrossel">
            <div class="slides" id="carrossel-slides">
                <div class="slide"><img src="imagem/GTA-6.jpg" alt=""></div>
                <div class="slide"><img src="imagem/RDR2.jpg" alt=""></div>
                <div class="slide"><img src="imagem/EA-SPORTS-FC-25.jpg" alt=""></div>
                <div class="slide"><img src="imagem/minecraft.jpg" alt=""></div>
                <div class="slide"><img src="imagem/Mortal-kombat.jpg" alt=""></div>
                <div class="slide"><img src="imagem/Resident-Evi4.jpg" alt=""></div>
                <div class="slide"><img src="imagem/spider-man.jpg" alt=""></div>
            </div>

            <button class="prev" id="carrossel-prev">&#10094;</button>
            <button class="next" id="carrossel-next">&#10095;</button>
        </div>

        <section class="categorias-secao">
            <div class="secao-top">
                <h2>Explora por categoria</h2>
                <div class="categoria-controls">
                    <button id="prev-cat" class="categoria-arrow">&#10094;</button>
                    <button id="next-cat" class="categoria-arrow">&#10095;</button>
                </div>
            </div>

            <div class="carrossel-categorias">
                <div class="lista-categorias" id="lista-categorias">
                    <div class="categoria-card" data-title="Ação" style="background-image: url('imagem/categoria-acao.jpg');">
                        <div class="categoria-overlay"></div>
                        <div class="categoria-label"><span>AÇÃO</span></div>
                    </div>

                    <div class="categoria-card" data-title="Aventura" style="background-image: url('imagem/categoria-aventura.jpg');">
                        <div class="categoria-overlay"></div>
                        <div class="categoria-label"><span>AVENTURA</span></div>
                    </div>

                    <div class="categoria-card" data-title="RPG" style="background-image: url('imagem/categoria-rpg.jpg');">
                        <div class="categoria-overlay"></div>
                        <div class="categoria-label"><span>RPG</span></div>
                    </div>

                    <div class="categoria-card" data-title="Esportes" style="background-image: url('imagem/categoria-esportes.jpg');">
                        <div class="categoria-overlay"></div>
                        <div class="categoria-label"><span>ESPORTES</span></div>
                    </div>

                    
                </div>

                <div class="dots" id="categoria-dots"></div>
            </div>
        </section>
        
        <section id="jogos-api-container" style="padding: 20px; display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;"></section>

    </main>

    <div id="cart-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Seu Carrinho</h2>
            <div id="cart-modal-content">
                </div>
            <div class="cart-summary">
                <strong>Total:</strong> <span id="cart-total">R$ 0.00</span>
            </div>
            <button class="checkout-btn">Finalizar Compra</button>
        </div>
    </div>
    
    <style>
    .modal {
        display: none; 
        position: fixed; 
        z-index: 1000; 
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.7); 
    }
    .modal-content {
        background-color: #5d34a1;
        margin: 10% auto; 
        padding: 30px;
        width: 80%; 
        max-width: 500px;
        border-radius: 10px;
        color: white;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }
    .close-button {
        color: #fff;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }
    .close-button:hover, .close-button:focus {
        color: #ccc;
        text-decoration: none;
        cursor: pointer;
    }
    #cart-modal-content ul { list-style: none; padding: 0; }
    #cart-modal-content li { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #7a46c3; font-size: 0.9em; }
    #cart-modal-content li span:first-child { width: 50%; }
    .cart-summary { margin-top: 20px; font-size: 1.3em; text-align: right; border-top: 2px solid #a050ff; padding-top: 10px; }
    .checkout-btn { background-color: #a050ff; color: white; border: none; padding: 12px 20px; border-radius: 5px; margin-top: 15px; cursor: pointer; width: 100%; font-weight: bold; }
    .game-card { width: 280px; background-color: #5d34a1; padding: 15px; border-radius: 8px; text-align: center; color: white;}
    .game-card img { max-width: 100%; height: auto; border-radius: 5px; }
    </style>

    <footer>
        <address class="endereco">
            Entre em contato: <a class="fonte-desc" href="mailto:contato@gamestream.com">contato@gamestream.com</a><br>
            Endereço: Brasília, 104, Distrito Federal
        </address>
    </footer>


    <script src="javascript/carrosel.js"></script> 
    <script src="javascript/carrinho.js" type="module"></script> 
    <script>
        // Script para rolar a lista de categorias e controlar bullets (SEU CÓDIGO ORIGINAL)
        (function() {
            const lista = document.getElementById('lista-categorias');
            const prev = document.getElementById('prev-cat');
            const next = document.getElementById('next-cat');
            const dotsContainer = document.getElementById('categoria-dots');

            const cards = Array.from(lista.querySelectorAll('.categoria-card'));
            const cardWidth = 320; 
            const gap = 20;
            const step = cardWidth + gap;

            // cria bullets
            const pages = Math.max(1, Math.ceil(cards.length / 3)); 
            let currentPage = 0;
            for (let i=0;i<pages;i++){
                const d = document.createElement('button');
                d.className = 'dot' + (i===0 ? ' active' : '');
                d.dataset.page = i;
                d.addEventListener('click', () => {
                    currentPage = i;
                    lista.scrollTo({ left: i * step * 3, behavior: 'smooth' });
                    updateDots();
                });
                dotsContainer.appendChild(d);
            }

            function updateDots(){
                dotsContainer.querySelectorAll('.dot').forEach((b, idx) => {
                    b.classList.toggle('active', idx === currentPage);
                });
            }

            prev.addEventListener('click', () => {
                currentPage = Math.max(0, currentPage - 1);
                lista.scrollTo({ left: currentPage * step * 3, behavior: 'smooth' });
                updateDots();
            });

            next.addEventListener('click', () => {
                currentPage = Math.min(pages - 1, currentPage + 1);
                lista.scrollTo({ left: currentPage * step * 3, behavior: 'smooth' });
                updateDots();
            });

          
            let isScrolling;
            lista.addEventListener('scroll', () => {
                window.clearTimeout(isScrolling);
                isScrolling = setTimeout(()=> {
                    const left = lista.scrollLeft;
                    currentPage = Math.round(left / (step * 3));
                    updateDots();
                }, 100);
            });
        })();
    </script>

    <script>
    const authButton = document.getElementById('authButton');
    const jogosContainer = document.getElementById('jogos-api-container'); 

    let currentUser = null;
    let GAMES_DATA = []; // Variável global para armazenar a lista de jogos

    // --- LÓGICA DE AUTENTICAÇÃO E LOGOUT ---
    function checkAuth() {
        const token = localStorage.getItem('userToken');
        const dataString = localStorage.getItem('userData');
        
        if (token && dataString) {
            try {
                const userData = JSON.parse(dataString);
                authButton.innerText = `Olá, ${userData.nome} (Sair)`;
                authButton.onclick = handleLogout;
                return userData;
            } catch (e) {
                handleLogout();
            }
        } else {
            authButton.innerText = 'Entrar';
            authButton.onclick = () => window.location.href = 'EscolherPerfil.html';
            return null;
        }
    }

    function handleLogout() {
        localStorage.removeItem('userToken');
        localStorage.removeItem('userData');
        // Limpa o carrinho ao deslogar
        const items = loadCartItems(); 
        if (items.length > 0 && confirm('Existem itens no seu carrinho. Deseja limpá-lo ao sair?')) {
            localStorage.removeItem(`carrinho_${currentUser ? currentUser.id : 'guest'}`);
        }
        window.location.reload();
    }

    // --- LÓGICA DE JOGOS (Requisição ao Backend) ---
    async function loadGames() {
        try {
            const response = await fetch('/api/games'); 
            if (!response.ok) {
                console.error("Erro ao carregar jogos:", response.status);
                jogosContainer.innerHTML = '<p style="color: red;">Erro ao carregar jogos da API.</p>';
                return;
            }

            const games = await response.json();
            GAMES_DATA = games; // SALVA OS DADOS
            
            jogosContainer.innerHTML = '<h2>Jogos em Destaque</h2>'; 
            
            games.forEach(game => {
                const gameCard = document.createElement('div');
                gameCard.className = 'game-card';
                gameCard.innerHTML = `
                    <img src="${game.imageUrl}" alt="${game.title}">
                    <h3>${game.title}</h3>
                    <p class="price">R$ ${game.price.toFixed(2)}</p>
                    ${currentUser ? 
                        `<button class="add-to-cart-btn" onclick="addToCart(${game.id})">Adicionar ao Carrinho</button>` 
                        : `<span class="login-prompt">Faça login para comprar</span>`
                    }
                `;
                jogosContainer.appendChild(gameCard);
            });

        } catch (error) {
            console.error("Erro de conexão ao buscar jogos:", error);
            jogosContainer.innerHTML = '<p style="color: red;">Erro de conexão com o servidor de jogos.</p>';
        }
    }

    // --- LÓGICA DO CARRINHO (CHAMA A FUNÇÃO EXTERNA) ---
    // Esta função agora pega o objeto completo do jogo e o envia para carrinho.js
    function addToCart(gameId) {
        if (currentUser) {
            const gameToAdd = GAMES_DATA.find(g => g.id === gameId);
            if (gameToAdd) {
                 // CHAMA A FUNÇÃO EXPOSTA PELO carrinho.js
                window.addItemToCart(gameToAdd); 
            }
        }
    }

    // Inicialização
    currentUser = checkAuth(); 
    loadGames(); 
    
    // Torna a função de carrinho acessível globalmente (para o carrinho.js)
    window.addToCart = addToCart; 
    </script>

</body>
</html>