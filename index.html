<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>GameStreamUniverse</title>

    <link rel="stylesheet" href="estilo.css">
    <link rel="shortcut icon" href="imagem/logoApp.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

    <header class="main-header">
        <div class="logo">
            <a href="index.html">
                <img src="imagem/logoApp.png" alt="GameUniverse Logo">
            </a>
        </div>

        <nav class="main-nav">
            <ul class="nav-links">
                <li><a href="categorias.html">Categorias</a></li>
                <li><a href="#">Jogos Mais Acessados</a></li>
                <li><a href="#">Novidades</a></li>
            </ul>
        </nav>

        <div class="header-actions">
            <div class="search-bar">
                <input type="text" placeholder="Pesquisar jogos...">
                <i class="fas fa-search"></i>
            </div>
            
            <a href="biblioteca.html" class="nav-link" title="Minha Biblioteca" style="color: white; margin-right: 15px; text-decoration: none; font-weight: 600;">Biblioteca</a> 

            <div class="shopping-cart" title="Carrinho">
                <i class="fas fa-shopping-cart"></i>
                <div class="cart-count">0</div> 
            </div>

            <div id="auth-status" class="login-btn">
                </div>
        </div>
    </header>

    <main>
        <div class="carrossel">
            <div class="slides" id="carrossel-slides">
                <div class="slide"><img src="imagem/gta5.jpg" alt=""></div>
                <div class="slide"><img src="imagem/RDR2.jpg" alt=""></div>
                <div class="slide"><img src="imagem/EA-SPORTS-FC-25.jpg" alt=""></div>
                <div class="slide"><img src="imagem/minecraft.jpg" alt=""></div>
                <div class="slide"><img src="imagem/detroit.jpg" alt=""></div>
                <div class="slide"><img src="imagem/Resident-Evi4.jpg" alt=""></div>
                <div class="slide"><img src="imagem/spider-man.jpg" alt=""></div>
                <div class="slide"><img src="imagem/elden-ring.jpg" alt=""></div>
                <div class="slide"><img src="imagem/god-of-war.jpg" alt=""></div>
            </div>

            <button class="prev" id="carrossel-prev">&#10094;</button>
            <button class="next" id="carrossel-next">&#10095;</button>
        </div>

        <section class="categorias-secao">
            <div class="secao-top">
                <h2>Explora por categoria</h2>
                <div class="categoria-controls">
                    <button id="prev-cat" class="categoria-arrow">&#10094;</button>
                    <button id="next-cat" class="categoria-arrow">&#10095;</button>
                </div>
            </div>

            <div class="carrossel-categorias">
                <div class="lista-categorias" id="lista-categorias">
                    <div class="categoria-card" data-title="A칞칚o" style="background-image: url('imagem/categoria-acao.jpg');">
                        <div class="categoria-overlay"></div>
                        <div class="categoria-label"><span>A칂츾O</span></div>
                    </div>

                    <div class="categoria-card" data-title="Aventura" style="background-image: url('imagem/categoria-aventura.jpg');">
                        <div class="categoria-overlay"></div>
                        <div class="categoria-label"><span>AVENTURA</span></div>
                    </div>

                    <div class="categoria-card" data-title="RPG" style="background-image: url('imagem/categoria-rpg.jpg');">
                        <div class="categoria-overlay"></div>
                        <div class="categoria-label"><span>RPG</span></div>
                    </div>

                    <div class="categoria-card" data-title="Esportes" style="background-image: url('imagem/categoria-esportes.jpg');">
                        <div class="categoria-overlay"></div>
                        <div class="categoria-label"><span>ESPORTES</span></div>
                    </div>
                </div>

                <div class="dots" id="categoria-dots"></div>
            </div>
        </section>
        
        <section id="jogos-api-container"></section> 

    </main>

    <div id="cart-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Seu Carrinho</h2>
            <div id="cart-modal-content">
                </div>
            <div class="cart-summary">
                <strong>Total:</strong> <span id="cart-total">R$ 0.00</span>
            </div>
            <button class="checkout-btn">Finalizar Compra</button>
        </div>
    </div>
    

    <footer>
        <address class="endereco">
            Entre em contato: <a class="fonte-desc" href="mailto:contato@gamestream.com">contato@gamestream.com</a><br>
            Endere칞o: Bras칤lia, 104, Distrito Federal
        </address>
    </footer>


    <script src="javascript/carrosel.js"></script> 
    <script src="javascript/carrinho.js" type="module"></script> 
    
    <script>
        // L칩gica do Carrossel de Categorias (n칚o alterada)
        (function() {
            const lista = document.getElementById('lista-categorias');
            const prev = document.getElementById('prev-cat');
            const next = document.getElementById('next-cat');
            const dotsContainer = document.getElementById('categoria-dots');

            const cards = Array.from(lista.querySelectorAll('.categoria-card'));
            const cardWidth = 320; 
            const gap = 20;
            const step = cardWidth + gap;

            const pages = Math.max(1, Math.ceil(cards.length / 3)); 
            let currentPage = 0;
            for (let i=0;i<pages;i++){
                const d = document.createElement('button');
                d.className = 'dot' + (i===0 ? ' active' : '');
                d.dataset.page = i;
                d.addEventListener('click', () => {
                    currentPage = i;
                    lista.scrollTo({ left: i * step * 3, behavior: 'smooth' });
                    updateDots();
                });
                dotsContainer.appendChild(d);
            }

            function updateDots(){
                dotsContainer.querySelectorAll('.dot').forEach((b, idx) => {
                    b.classList.toggle('active', idx === currentPage);
                });
            }

            prev.addEventListener('click', () => {
                currentPage = Math.max(0, currentPage - 1);
                lista.scrollTo({ left: currentPage * step * 3, behavior: 'smooth' });
                updateDots();
            });

            next.addEventListener('click', () => {
                currentPage = Math.min(pages - 1, currentPage + 1);
                lista.scrollTo({ left: currentPage * step * 3, behavior: 'smooth' });
                updateDots();
            });

            let isScrolling;
            lista.addEventListener('scroll', () => {
                window.clearTimeout(isScrolling);
                isScrolling = setTimeout(()=> {
                    const left = lista.scrollLeft;
                    currentPage = Math.round(left / (step * 3));
                    updateDots();
                }, 100);
            });
        })();
    </script>
    
    <script>
    const jogosContainer = document.getElementById('jogos-api-container'); 
    let currentUser = null; 
    let GAMES_DATA = []; 

    // 1. L칍GICA DE AUTENTICA칂츾O E LOGOUT
    function checkAuth() {
        const dataString = localStorage.getItem('userData');
        
        if (dataString) {
            try {
                currentUser = JSON.parse(dataString); 
            } catch (e) {
                handleLogout();
                currentUser = null;
            }
        } else {
            currentUser = null;
        }
        updateHeaderAuth(); 
        return currentUser;
    }

    // REQUISITO: Usu치rio e ADM podem deslogar
    function handleLogout() {
        localStorage.removeItem('userToken');
        localStorage.removeItem('userData');
        window.location.href = 'index.html'; 
    }
    window.handleLogout = handleLogout; // Torna acess칤vel no HTML

    // 游뛀 FUN칂츾O DE AUTENTICA칂츾O CORRIGIDA PARA USAR O ESTILO ORIGINAL
    function updateHeaderAuth() {
        const authStatusElement = document.getElementById('auth-status');
        let contentHTML = ''; 
        
        if (!authStatusElement) return; // Seguran칞a

        if (currentUser) {
            // LOGADO: Monta status e links de permiss칚o
            const nomeCurto = currentUser.nome.split(' ')[0];
            let actionLinks = '';
            
            // Link Desenvolvedor
            if (currentUser.developer) { 
                 // Mantendo as cores originais do seu projeto: #00ffaa para DEV
                 actionLinks += `<a href="Admin_PostarJogo.html" style="color: #00ffaa; font-weight:bold; text-decoration: none;">Postar Jogo</a> | `;
            }
            
            // Link ADM
            if (currentUser.adm) { 
                // Mantendo as cores originais do seu projeto: #ffaa00 para ADM
                actionLinks += `<a href="Admin.html" style="color: #ffaa00; font-weight:bold; text-decoration: none;">ADM Panel</a> | `;
            }
            
            // Conte칰do final quando logado
            contentHTML = `
                <div class="login-status-text" style="
                    display:flex; 
                    align-items:center; 
                    gap: 8px; 
                    font-size: 0.95rem; 
                    white-space: nowrap;
                ">
                    ${actionLinks}
                    <span style="color: #fff; font-weight: 600;">Ol치, ${nomeCurto}</span>
                    <span onclick="handleLogout()" style="cursor:pointer; color:#a050ff; font-weight:normal; text-decoration: none;">(Sair)</span>
                </div>
            `;
            
            authStatusElement.innerHTML = contentHTML;
            // Remove a classe de bot칚o quando est치 logado
            authStatusElement.classList.remove('login-btn'); 

        } else {
            // DESLOGADO: Renderiza o bot칚o "Entrar"
            authStatusElement.innerHTML = `
                <button onclick="window.location.href = 'EscolherPerfil.html'" class="login-btn">Entrar</button>
            `;
            // Adiciona a classe de bot칚o para estilo
            authStatusElement.classList.add('login-btn');
        }
    }


    // 2. L칍GICA DE JOGOS
    async function loadGames() {
        try {
        
            const response = await fetch('http://localhost:3000/api/games'); 
            if (!response.ok) {
                throw new Error("Erro ao carregar jogos (Verifique o log do Node).");
            }

            const games = await response.json();
            GAMES_DATA = games; 
            
            jogosContainer.innerHTML = '<h2>Jogos em Destaque</h2>'; 
            
            games.forEach(game => {
                const gameCard = document.createElement('div');
                gameCard.className = 'game-card';
                gameCard.innerHTML = `
                    <img src="${game.imageUrl}" alt="${game.title}">
                    <h3>${game.title}</h3>
                    <p class="price">R$ ${parseFloat(game.price).toFixed(2)}</p>
                    ${currentUser ? 
                        `<button class="add-to-cart-btn" onclick="addToCart(${game.id})">Adicionar ao Carrinho</button>` 
                        : `<span class="login-prompt">Fa칞a login para comprar</span>`
                    }
                `;
                jogosContainer.appendChild(gameCard);
            });

        } catch (error) {
            console.error("Erro de conex칚o ao buscar jogos:", error);
            jogosContainer.innerHTML = `<p style="color: red;">Erro ao carregar jogos: ${error.message}</p>`;
        }
    }

    // 3. ADICIONAR AO CARRINHO (CHAMA A FUN칂츾O EM carrinho.js)
    function addToCart(gameId) {
        if (currentUser) {
            const gameToAdd = GAMES_DATA.find(g => g.id === gameId);
            if (gameToAdd) {
                // Chama a fun칞칚o global exposta pelo carrinho.js
                window.addItemToCart(gameToAdd); 
            }
        }
    }

    // Inicializa칞칚o da aplica칞칚o
    currentUser = checkAuth(); // Tenta carregar o usu치rio logado
    loadGames(); // Carrega os jogos
    window.addToCart = addToCart; 
    </script>

</body>
</html>